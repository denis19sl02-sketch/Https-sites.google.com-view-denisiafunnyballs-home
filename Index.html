<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="google-site-verification" content="Y0TPXpIbpcaoCoSttVeYD9B7bLAZF6LetAE2EA7xFdk" />
  <meta charset="utf-8" />
  <title>Blue Ball Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- Google Site Verification -->
  <meta name="google-site-verification" content="fcc94383797d5f9b" />

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6953607729761574"
     crossorigin="anonymous"></script>

  <style>
  /* –í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
  html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden;font-family:sans-serif;background:#87CEEB;}
  canvas{display:block;position:absolute;left:0;top:0;z-index:5;}
  .btn,.level-btn{border:none;cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent;display:flex;align-items:center;justify-content:center;transition:transform .12s ease,box-shadow .12s ease,background .12s ease;}
  .btn{width:120px;height:120px;border-radius:50%;font-weight:bold;font-size:18px;position:absolute;box-shadow:0 6px 12px rgba(0,0,0,0.25);color:white;}
  .level-btn{width:80px;height:80px;border-radius:50%;font-size:24px;font-weight:bold;box-shadow:0 4px 8px rgba(0,0,0,0.3);color:white;}
  .btn-pressed{transform:translateY(6px) scale(.98);box-shadow:0 3px 8px rgba(0,0,0,.22);}
  .level-btn-pressed{transform:translateY(4px) scale(.98);box-shadow:0 2px 6px rgba(0,0,0,.22);}
  .btn-endless{background:#2ecc71;left:50%;top:25%;transform:translate(-50%,-50%);}
  .btn-start{background:#f1c40f;color:#111;left:50%;top:50%;transform:translate(-50%,-50%);}
  .btn-simple{background:#40E0D0; left:63%; top:44%; transform:translate(-50%,-50%);}
  .btn-levels{background:#9b59b6;right:10%;top:50%;transform:translateY(-50%);}
  .btn-home{background:#3498db;left:10%;top:50%;transform:translateY(-50%);}
  #menu,#levelMenu,#homePage,#colorPage{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:30;background:transparent;}
  #rightPanel{position:absolute;right:28px;top:36px;z-index:31;display:flex;flex-direction:column;align-items:center;gap:12px;pointer-events:none;}
  #scoreDisplay{pointer-events:auto;font-size:20px;font-weight:bold;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.4);background:rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;}
  #jumpBtn{pointer-events:auto;width:96px;height:96px;border-radius:50%;border:none;background:#f1c40f;color:#111;font-weight:bold;font-size:18px;box-shadow:0 6px 12px rgba(0,0,0,0.25);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .12s ease,box-shadow .12s ease;}
  #overlay{position:absolute;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:50;background:rgba(0,0,0,0.6);color:white;font-size:36px;}
  #overlay .box{background:rgba(0,0,0,0.5);padding:18px 24px;border-radius:12px;text-align:center;}
  #overlay button{margin-top:14px;padding:8px 14px;font-size:18px;}
  #levelMenu{display:none;flex-direction:row;flex-wrap:wrap;justify-content:center;align-items:flex-start;padding-top:90px;gap:18px;background:transparent;}
  .locked{background:#888;cursor:default;color:#ddd;box-shadow:0 2px 4px rgba(0,0,0,0.2) !important;}
  #homePage{background:transparent;flex-direction:column;justify-content:flex-start;display:none;align-items:center;padding-top:60px;gap:18px;}
  #homePage h1{color:#0077FF;font-size:72px;margin-top:18px;text-shadow:none;}
  .home-btn{font-size:20px;font-weight:bold;border:none;border-radius:12px;padding:10px 18px;cursor:pointer;box-shadow:0 5px 10px rgba(0,0,0,0.3);transition:transform .15s ease;}
  .home-btn:active{transform:scale(.96);}
  #homeMsg{margin-top:8px;color:#003377;font-size:18px;font-weight:bold;opacity:0;transition:opacity .35s ease;}
  .mainBtn{position:absolute;top:10px;right:10px;background:#004b00;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font-size:14px;z-index:100;transition:transform .1s ease;display:none;}
  .mainBtn:active{transform:scale(.95);}
  .selection-indicator{position:absolute; left:50%; top:62%; transform:translate(-50%,-50%); font-size:14px; color:#003; background:rgba(255,255,255,0.12); padding:6px 10px; border-radius:10px; z-index:32; display:none;}
  /* color page styling */
  #colorGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;padding:24px;max-width:900px;width:92%;justify-items:center;}
  .color-btn{width:72px;height:72px;border-radius:50%;border:3px solid rgba(255,255,255,0.6);cursor:pointer;box-shadow:0 6px 12px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;}
  .color-name{font-size:13px;margin-top:6px;color:#003;}
  #colorPage{display:none;flex-direction:column;align-items:center;justify-content:flex-start;padding-top:40px;}
  .color-card{display:flex;flex-direction:column;align-items:center;}
  @media (max-width:520px){.btn{width:88px;height:88px;font-size:14px;}.level-btn{width:64px;height:64px;font-size:18px;}#homePage h1{font-size:56px;}.btn-simple{left:60%;}}

  /* AD overlay styles */
  #adOverlay{display:none;position:fixed;left:0;top:0;width:100%;height:100%;z-index:110;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;flex-direction:column;padding:18px;box-sizing:border-box;}
  #adBox{width:90%;max-width:900px;position:relative;background:transparent;border-radius:8px;padding:12px;box-sizing:border-box;}
  #adControls{margin-top:14px;display:flex;gap:12px;align-items:center;justify-content:center;}
  .ad-continue{padding:10px 18px;border-radius:8px;border:none;background:#2ecc71;color:#fff;font-weight:bold;cursor:pointer;}
  .ad-skip{padding:10px 18px;border-radius:8px;border:none;background:#f39c12;color:#111;font-weight:bold;cursor:pointer;}
  .ad-note{color:#ddd;font-size:14px;margin-top:8px;text-align:center;}
  </style>
</head>
<body>
  <button id="mainBtn" class="mainBtn">GO TO THE MAIN PAGE</button>

  <div id="menu">
    <button class="btn btn-endless" id="btnEndless">ENDLESS</button>
    <button class="btn btn-start" id="btnStart">START</button>
    <button class="btn btn-simple" id="btnSimple">SIMPLE GAME</button>
    <button class="btn btn-levels" id="btnLevels">LEVELS</button>
    <button class="btn btn-home" id="btnHome">HOME</button>
    <div id="selectionIndicator" class="selection-indicator"></div>
  </div>

  <div id="levelMenu"><h1>LEVELS</h1></div>

  <canvas id="game"></canvas>

  <div id="rightPanel">
    <div id="scoreDisplay">0</div>
    <button id="jumpBtn">JUMP</button>
  </div>

  <div id="overlay">
    <div class="box">
      <div id="message"></div>
      <button id="overlayMainBtn">GO TO THE MAIN PAGE</button>
    </div>
  </div>

  <div id="homePage">
    <h1>HOME</h1>
    <button id="ownRecord" class="home-btn" style="background:#7CFC00;color:black;">OWN RECORD: 0</button>
    <button id="completedLvls" class="home-btn" style="background:#4B0082;color:white;">COMPLETED LEVELS: 0</button>
    <button id="colorPickerBtn" class="home-btn" style="background:#00BFFF;color:black;">THE COLOR OF THE BALL IS</button>
    <div id="homeMsg"></div>
  </div>

  <!-- Color selection page -->
  <div id="colorPage">
    <h1 style="color:#0077FF;margin-bottom:8px;">Choose ball color</h1>
    <div id="colorGrid"></div>
    <button id="colorBack" class="home-btn" style="margin-top:18px;">BACK</button>
  </div>

  <!-- AD OVERLAY -->
  <div id="adOverlay" role="dialog" aria-hidden="true">
    <div id="adBox">
      <!-- AdSense –±–ª–æ–∫ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
      <div id="adContainer" style="min-height:120px;display:flex;align-items:center;justify-content:center;"></div>

      <div id="adControls">
        <button id="adContinue" class="ad-continue">Continue</button>
        <button id="adSkip" class="ad-skip">Skip</button>
      </div>

      <div class="ad-note">–†–µ–∫–ª–∞–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ Google ‚Äî –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.</div>
    </div>
  </div>

<script>
/* --- canvas setup --- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// UI refs
const btnEndless = document.getElementById('btnEndless'),
      btnStart   = document.getElementById('btnStart'),
      btnSimple  = document.getElementById('btnSimple'),
      btnLevels  = document.getElementById('btnLevels'),
      btnHome    = document.getElementById('btnHome'),
      jumpBtn    = document.getElementById('jumpBtn'),
      menu       = document.getElementById('menu'),
      levelMenu  = document.getElementById('levelMenu'),
      overlay    = document.getElementById('overlay'),
      overlayMainBtn = document.getElementById('overlayMainBtn'),
      messageBox = document.getElementById('message'),
      scoreEl    = document.getElementById('scoreDisplay'),
      homePage   = document.getElementById('homePage'),
      homeMsg    = document.getElementById('homeMsg'),
      ownRecordBtn = document.getElementById('ownRecord'),
      completedLvlsBtn = document.getElementById('completedLvls'),
      mainBtn    = document.getElementById('mainBtn'),
      selectionIndicator = document.getElementById('selectionIndicator'),
      colorPickerBtn = document.getElementById('colorPickerBtn'),
      colorPage = document.getElementById('colorPage'),
      colorGrid = document.getElementById('colorGrid'),
      colorBack = document.getElementById('colorBack'),
      adOverlay = document.getElementById('adOverlay'),
      adContainer = document.getElementById('adContainer'),
      adContinue = document.getElementById('adContinue'),
      adSkip = document.getElementById('adSkip');

let mode = 'menu';
let simpleSelected=false, endlessSelected=false;
let inGame=false, gameOver=false;
let score=0, cameraX=0, fences=[], currentLevel=0;
let unlockedLevel = parseInt(localStorage.getItem('unlockedLevel')) || 1;
let bestRecord = parseInt(localStorage.getItem('bestRecord')) || 0;

// ball color persisted
let ballColor = localStorage.getItem('ballColor') || '#00BFFF';
function setBallColor(c){
  ballColor = c;
  localStorage.setItem('ballColor', c);
  const name = colorNameForHex(c) || '';
  colorPickerBtn.textContent = 'THE COLOR OF THE BALL IS ' + (name ? name.toUpperCase() : '');
}
function colorNameForHex(hex){
  hex = hex.toLowerCase();
  const map = {
    '#00bfff':'blue',
    '#ffd700':'gold',
    '#ffff00':'yellow',
    '#ffffff':'white',
    '#f5f5dc':'cream',
    '#808080':'gray',
    '#8a2be2':'violet',
    '#ff69b4':'pink',
    '#ff0000':'red',
    '#008000':'green',
    '#000000':'black',
    '#8b4513':'brown'
  };
  return map[hex] || null;
}
setBallColor(ballColor);

// physics & player
const walkSpeed = 1.6, gravity = 0.8, jumpPower = -18, forwardJump = 2;
let player = { x:50, y:300, vy:0, vx:0, radius:25, onGround:true };

// ----- WebAudio setup -----
let audioCtx = null;
function ensureAudioCtx(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return null;
    audioCtx = new AC();
  }
  return audioCtx;
}

// click sound (UI)
function playClick(){
  const ac = ensureAudioCtx(); if(!ac) return;
  const now = ac.currentTime;
  const o = ac.createOscillator(), g = ac.createGain();
  o.type='square'; o.frequency.setValueAtTime(1000, now);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.22, now+0.008);
  g.gain.exponentialRampToValueAtTime(0.0001, now+0.06);
  o.connect(g); g.connect(ac.destination);
  o.start(now); o.stop(now+0.07);
}

// fence pass sound
function playFenceSound(){
  const ac = ensureAudioCtx(); if(!ac) return;
  const now = ac.currentTime;
  const o = ac.createOscillator(), g = ac.createGain();
  o.type='sine'; o.frequency.setValueAtTime(700, now);
  o.frequency.exponentialRampToValueAtTime(180, now+0.28);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.35, now+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, now+0.32);
  o.connect(g); g.connect(ac.destination);
  o.start(now); o.stop(now+0.33);
}

// GAME OVER sound
function playGameOverSound(){
  const ac = ensureAudioCtx(); if(!ac) return;
  const now = ac.currentTime;
  const freqs = [400, 320, 240];
  freqs.forEach((f,i)=>{
    const o = ac.createOscillator();
    o.type='sawtooth';
    const start = now + i*0.12;
    o.frequency.setValueAtTime(f, start);
    const gg = ac.createGain();
    gg.gain.setValueAtTime(0.0001, start);
    gg.gain.exponentialRampToValueAtTime(0.25, start+0.01);
    gg.gain.exponentialRampToValueAtTime(0.0001, start+0.18);
    o.connect(gg); gg.connect(ac.destination);
    o.start(start); o.stop(start+0.19);
  });
}

// VICTORY sound
function playVictorySound(){
  const ac = ensureAudioCtx(); if(!ac) return;
  const now = ac.currentTime;
  const notes = [880, 1046, 1318, 1760];
  notes.forEach((n,i)=>{
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = 'triangle';
    const start = now + i*0.12;
    o.frequency.setValueAtTime(n, start);
    g.gain.setValueAtTime(0.0001, start);
    g.gain.exponentialRampToValueAtTime(0.28, start+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, start+0.22);
    o.connect(g); g.connect(ac.destination);
    o.start(start); o.stop(start+0.25);
  });
  setTimeout(()=>{
    const o2 = ac.createOscillator(), g2 = ac.createGain();
    o2.type = 'sine'; o2.frequency.setValueAtTime(1320, ac.currentTime);
    g2.gain.setValueAtTime(0.0001, ac.currentTime);
    g2.gain.exponentialRampToValueAtTime(0.22, ac.currentTime+0.01);
    g2.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.45);
    o2.connect(g2); g2.connect(ac.destination);
    o2.start(ac.currentTime); o2.stop(ac.currentTime+0.45);
  }, 520);
}

// animate press wrapper
function animatePress(el, cb){
  if(!el) return;
  try{ playClick(); }catch(e){}
  const cls = el.classList && el.classList.contains('level-btn') ? 'level-btn-pressed' : 'btn-pressed';
  el.classList.add(cls);
  setTimeout(()=>{ el.classList.remove(cls); if(typeof cb === 'function') cb(); }, 120);
}

function saveProgress(){ localStorage.setItem('bestRecord', bestRecord); localStorage.setItem('unlockedLevel', unlockedLevel); }

// --- Buttons wiring ---
btnEndless.onclick = ()=> animatePress(btnEndless, ()=> { endlessSelected=true; simpleSelected=false; selectionIndicator.style.display='block'; selectionIndicator.textContent='ENDLESS selected ‚Äî press START'; });
btnSimple.onclick  = ()=> animatePress(btnSimple,  ()=> { simpleSelected=true; endlessSelected=false; selectionIndicator.style.display='block'; selectionIndicator.textContent='SIMPLE GAME selected ‚Äî press START'; });
btnStart.onclick   = ()=> animatePress(btnStart,   ()=>{
  if(simpleSelected || endlessSelected){
    if(simpleSelected) startGame('simple'); else startGame('endless');
    selectionIndicator.style.display='none';
    simpleSelected = endlessSelected = false;
  } else {
    selectionIndicator.style.display='block'; selectionIndicator.textContent='NO MODE SELECTED';
    setTimeout(()=> selectionIndicator.style.display='none', 900);
  }
});
btnLevels.onclick = ()=> animatePress(btnLevels, showLevelMenu);
btnHome.onclick   = ()=> animatePress(btnHome, openHome);
jumpBtn.onclick   = ()=> animatePress(jumpBtn, jump);
mainBtn.onclick   = goToMain;
overlayMainBtn.onclick = goToMain;

window.addEventListener('keydown', e=>{
  if(inGame && (e.code==='Space' || e.code==='KeyJ')){ e.preventDefault(); animatePress(jumpBtn, jump); }
});

// --- Color picker page wiring ---
const colors = [
  {hex:'#00BFFF', name:'blue'},
  {hex:'#FFD700', name:'gold'},
  {hex:'#FFFF00', name:'yellow'},
  {hex:'#FFFFFF', name:'white'},
  {hex:'#F5F5DC', name:'cream'},
  {hex:'#808080', name:'gray'},
  {hex:'#8A2BE2', name:'violet'},
  {hex:'#FF69B4', name:'pink'},
  {hex:'#FF0000', name:'red'},
  {hex:'#008000', name:'green'},
  {hex:'#000000', name:'black'},
  {hex:'#8B4513', name:'brown'}
];

function openColorPage(){
  colorPage.style.display = 'flex';
  menu.style.display = 'none';
  levelMenu.style.display = 'none';
  homePage.style.display = 'none';
  overlay.style.display = 'none';
  selectionIndicator.style.display = 'none';
  if(colorGrid.childElementCount === 0){
    colors.forEach(c=>{
      const card = document.createElement('div');
      card.className = 'color-card';
      const btn = document.createElement('button');
      btn.className = 'color-btn';
      btn.style.background = c.hex;
      btn.title = c.name;
      btn.onclick = ()=> {
        animatePress(btn, ()=> {
          setBallColor(c.hex);
        });
      };
      const label = document.createElement('div');
      label.className = 'color-name';
      label.textContent = c.name.toUpperCase();
      card.appendChild(btn);
      card.appendChild(label);
      colorGrid.appendChild(card);
    });
  }
}
colorPickerBtn.onclick = ()=> animatePress(colorPickerBtn, openColorPage);
colorBack.onclick = ()=> { animatePress(colorBack, ()=> { colorPage.style.display='none'; openHome(); }); };

/* --- AD handling (AdSense block injection) --- */
function injectAdSenseBlock(){
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ä–µ–∫–ª–∞–º—É
  adContainer.innerHTML = '';

  // –°–æ–∑–¥–∞–µ–º AdSense –±–ª–æ–∫
  const ins = document.createElement('ins');
  ins.className = 'adsbygoogle';
  ins.style.display = 'block';
  ins.setAttribute('data-ad-client', 'ca-pub-6953607729761574');
  ins.setAttribute('data-ad-slot', '1234567890'); // –ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π ad-slot
  ins.setAttribute('data-ad-format', 'auto');
  ins.setAttribute('data-full-width-responsive', 'true');
  
  adContainer.appendChild(ins);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∫–ª–∞–º—É
  try {
    (adsbygoogle = window.adsbygoogle || []).push({});
  } catch(e) {
    console.warn('AdSense error:', e);
  }
}

function showAdOverlayThen(callbackAfterClose){
  injectAdSenseBlock();
  adOverlay.style.display = 'flex';
  adOverlay.setAttribute('aria-hidden', 'false');

  adContinue.disabled = false;
  adSkip.disabled = false;

  function closeAndContinue(){
    adOverlay.style.display = 'none';
    adOverlay.setAttribute('aria-hidden', 'true');
    adContainer.innerHTML = '';
    if(typeof callbackAfterClose === 'function') callbackAfterClose();
    adContinue.removeEventListener('click', onContinue);
    adSkip.removeEventListener('click', onSkip);
  }
  function onContinue(){ closeAndContinue(); }
  function onSkip(){ closeAndContinue(); }

  adContinue.addEventListener('click', onContinue);
  adSkip.addEventListener('click', onSkip);
}

/* --- game control functions --- */
function goToMain(){
  mode = 'menu';
  inGame = false;
  menu.style.display='flex';
  levelMenu.style.display='none';
  overlay.style.display='none';
  jumpBtn.style.display='none';
  homePage.style.display='none';
  mainBtn.style.display='none';
  selectionIndicator.style.display='none';
  endlessSelected = simpleSelected = false;
  currentLevel = 0;
  updateScoreDisplay();
}

function startGame(startMode){
  mode = startMode;
  inGame = true;
  menu.style.display = 'none';
  levelMenu.style.display='none';
  overlay.style.display='none';
  homePage.style.display='none';
  colorPage.style.display='none';
  jumpBtn.style.display='block';
  mainBtn.style.display='block';
  gameOver = false;
  score = 0;
  player = { x:50, y: Math.min(300, canvas.height * 0.75), vy:0, vx:0, radius:25, onGround:true };
  fences = [];
  if(mode === 'simple'){
    for(let i=0;i<10;i++){
      fences.push({ x: 300 + i*200, y: player.y, width:20, height:50, passed:false });
    }
  } else {
    for(let i=0;i<10;i++){
      fences.push({ x: 300 + i*200, y: player.y, width:20, height:50, passed:false });
    }
  }
  updateScoreDisplay();
}

function jump(){
  if(inGame && player.onGround && !gameOver){
    player.vy = jumpPower; player.vx = forwardJump; player.onGround = false;
  }
}

function updatePlayer(){
  if(!inGame) return;
  player.vy += gravity;
  player.y += player.vy;
  player.x += walkSpeed + (player.vx || 0);
  const gY = Math.min(canvas.height * 0.75, 300);
  if(player.y >= gY){ player.y = gY; player.vy = 0; player.vx = 0; player.onGround = true; }
  cameraX = player.x - canvas.width / 4;
}

function checkCollisions(){
  if(!inGame) return;
  for(const f of fences){
    if(player.x + player.radius > f.x && player.x - player.radius < f.x + f.width && player.y > f.y - f.height){
      gameOver = true;
      try{ playGameOverSound(); }catch(e){}
      showAdOverlayThen(()=> {
        showMessage("GAME OVER", 'gameover');
      });
      return;
    }
  }
}

function checkVictory(){
  if(!inGame) return;
  for(const f of fences){
    if(!f.passed && player.x > f.x + f.width){
      f.passed = true;
      score++;
      updateScoreDisplay();
      try{ playFenceSound(); }catch(e){}
      if(mode === 'endless' && score > bestRecord){
        bestRecord = score; saveProgress();
      }
    }
  }

  if((mode === 'simple' || mode === 'level') && fences.length > 0 && score === fences.length && !gameOver){
    gameOver = true;
    try{ playVictorySound(); }catch(e){}
    if(mode === 'level' && currentLevel < 35){
      unlockedLevel = Math.max(unlockedLevel, currentLevel + 1);
      saveProgress();
    }
    showAdOverlayThen(()=> {
      showMessage("VICTORY", 'victory');
    });
  }

  if(mode === 'endless' && fences.length > 0){
    const last = fences[fences.length - 1];
    if(player.x > last.x - canvas.width){
      fences.push({ x: last.x + 200, y: last.y, width:20, height:50, passed:false });
    }
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const gY = Math.min(canvas.height * 0.75, 300);
  ctx.fillStyle = '#87CEEB'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#3CB371'; ctx.fillRect(0, gY, canvas.width, canvas.height - gY);
  ctx.fillStyle = 'saddlebrown';
  for(const f of fences){
    const sx = Math.round(f.x - cameraX);
    ctx.fillRect(sx, f.y - f.height, f.width, f.height);
  }
  const sx = Math.round(player.x - cameraX);
  ctx.beginPath();
  ctx.arc(sx, player.y, player.radius, 0, Math.PI*2);
  ctx.fillStyle = ballColor;
  ctx.fill();
}

function update(){
  if(inGame && !gameOver){
    updatePlayer();
    checkCollisions();
    checkVictory();
  }
  updateScoreDisplay();
}
function loop(){
  update(); draw();
  requestAnimationFrame(loop);
}
loop();

function updateScoreDisplay(){
  if(inGame && (mode === 'level' || mode === 'simple') && fences.length > 0){
    scoreEl.textContent = score + '/' + fences.length;
  } else if(inGame && mode === 'endless'){
    scoreEl.textContent = String(score);
  } else {
    scoreEl.textContent = '0';
  }
}

function showMessage(text, type){
  messageBox.textContent = (type === 'victory') ? 'VICTORY' : (type === 'gameover' ? 'GAME OVER' : text);
  overlay.style.display = 'flex';
  jumpBtn.style.display = 'none';
  mainBtn.style.display = 'block';
}

function showLevelMenu(){
  mode = 'menu'; inGame=false; menu.style.display='none'; levelMenu.style.display='flex'; mainBtn.style.display='block';
  levelMenu.innerHTML = '<h1>LEVELS</h1>';
  const c = document.createElement('div');
  c.style.width='100%'; c.style.maxWidth='820px'; c.style.display='flex'; c.style.flexWrap='wrap'; c.style.justifyContent='center'; c.style.gap='18px'; c.style.paddingTop='70px';
  const colorsList = ['#FF6B6B','#4CAF50','#FFD54F','#9C27B0','#FF9800','#00BCD4','#FF4081','#00796B','#FFC107','#7CB342'];
  for(let i=1;i<=35;i++){
    const b = document.createElement('button');
    b.className = 'level-btn'; b.style.background = colorsList[(i-1)%colorsList.length];
    b.textContent = i;
    if(i > unlockedLevel){ b.classList.add('locked'); b.textContent = 'üîí'; b.disabled = true; } else {
      b.addEventListener('click', ()=> animatePress(b, ()=> startLevel(i)));
    }
    c.appendChild(b);
  }
  levelMenu.appendChild(c);
}
function startLevel(n){
  inGame=true; mode='level'; currentLevel=n;
  levelMenu.style.display='none'; jumpBtn.style.display='block'; mainBtn.style.display='block';
  gameOver=false; score=0;
  player = { x:50, y: Math.min(300, canvas.height * 0.75), vy:0, vx:0, radius:25, onGround:true };
  fences = [];
  for(let i=0;i<n*10;i++){
    fences.push({ x: 300 + i*200, y: player.y, width:20, height:50, passed:false });
  }
  updateScoreDisplay();
}

function openHome(){
  mode='menu'; inGame=false; menu.style.display='none'; levelMenu.style.display='none'; overlay.style.display='none';
  jumpBtn.style.display='none'; homePage.style.display='flex'; mainBtn.style.display='block';
  ownRecordBtn.textContent = "OWN RECORD: " + bestRecord;
  completedLvlsBtn.textContent = "COMPLETED LEVELS: " + (unlockedLevel - 1);
}
function showHomeMessage(t){
  homeMsg.textContent = t; homeMsg.style.opacity = 1; setTimeout(()=> homeMsg.style.opacity = 0, 6000);
}
ownRecordBtn.onclick = ()=> showHomeMessage("JUMPED FENCES IN ENDLESS MODE");
completedLvlsBtn.onclick = ()=> showHomeMessage("COMPLETED LEVELS IN LEVELS MODE");

// initial UI state
menu.style.display='flex';
levelMenu.style.display='none';
overlay.style.display='none';
jumpBtn.style.display='none';
homePage.style.display='none';
mainBtn.style.display='none';
selectionIndicator.style.display='none';
updateScoreDisplay();

</script>
</body>
  </html>
